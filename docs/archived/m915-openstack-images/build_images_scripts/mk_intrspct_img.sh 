#!/bin/sh -e

KVER=4.18.0-193.51.1.el8_2

if [ -z $MYWDIR ]
then
  echo "Check MYWDIR environment variable"
  exit 1
elif [ ! -d $MYWDIR/src_extracted ]
then
   echo "Missing $MYWDIR/src_extracted directory"
   exit 1
fi

mkdir $MYWDIR/tmp.ironic-initrd
cd $MYWDIR/tmp.ironic-initrd
zcat $MYWDIR/src_extracted/ironic-python-agent.initramfs |cpio -id 
cp -f lib/modules/$KVER.x86_64/kernel/drivers/scsi/mpt3sas/mpt3sas.ko.xz lib/modules/$KVER.x86_64/kernel/drivers/scsi/mpt3sas/mpt3sas.ko.xz.orig
cp -f $MYWDIR/src_extracted/mpt3sas.ko.xz lib/modules/$KVER.x86_64/kernel/drivers/scsi/mpt3sas/mpt3sas.ko.xz
mkdir lib/modules/$KVER.x86_64/orig
cp lib/modules/$KVER.x86_64/modules.* lib/modules/$KVER.x86_64/orig/
depmod -b $MYWDIR/tmp.ironic-initrd $KVER.x86_64
mkdir -p $MYWDIR/built
find . 2>/dev/null | cpio --quiet -c -o | gzip -8 > $MYWDIR/built/ironic-python-agent-custom.initramfs
cp $MYWDIR/src_extracted/ironic-python-agent.kernel $MYWDIR/built/ironic-python-agent-custom.kernel
